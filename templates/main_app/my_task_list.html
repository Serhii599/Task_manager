{% extends "base.html" %}
{% block title %}My tasks table{% endblock %}

{% block content %}

<div class="filters-box">
    <form method="get" id="filtersForm" style="margin-bottom:20px">

        <!-- STATUS -->
        <select class="custom-select" name="status" onchange="filtersForm.submit()">
            <option value="">All statuses</option>
            <option value="Backlog"      {% if request.GET.status == "Backlog" %}selected{% endif %}>Backlog</option>
            <option value="In Progress"  {% if request.GET.status == "In Progress" %}selected{% endif %}>In Progress</option>
            <option value="Done"         {% if request.GET.status == "Done" %}selected{% endif %}>Done</option>
        </select>

        <!-- PRIORITY -->
        <select class="custom-select" name="priority" onchange="filtersForm.submit()">
            <option value="">All priorities</option>
            <option value="Low"     {% if request.GET.priority == "Low" %}selected{% endif %}>Low</option>
            <option value="Medium"  {% if request.GET.priority == "Medium" %}selected{% endif %}>Medium</option>
            <option value="High"    {% if request.GET.priority == "High" %}selected{% endif %}>High</option>
            <option value="Urgent"  {% if request.GET.priority == "Urgent" %}selected{% endif %}>Urgent</option>
        </select>

        <!-- PROJECT -->
        <select class="custom-select" name="project" onchange="filtersForm.submit()">
            <option value="">All projects</option>
            {% for project in projects %}
                <option value="{{ project.id }}" {% if request.GET.project == project.id|stringformat:'s' %}selected{% endif %}>
                    {{ project.project_name }}
                </option>
            {% endfor %}
        </select>

        <!-- ASSIGNEE -->
        <select class="custom-select" name="assignee" onchange="filtersForm.submit()">
            <option value="">All assignees</option>
            {% for user in assignees %}
                <option value="{{ user.id }}" {% if request.GET.assignee == user.id|stringformat:'s' %}selected{% endif %}>
                    {{ user.first_name }}
                </option>
            {% endfor %}
        </select>

        <!-- DATE RANGE -->
        <input type="date" name="date_from" class="custom-date" value="{{ request.GET.date_from }}">
        <input type="date" name="date_to" class="custom-date" value="{{ request.GET.date_to }}">

        <button type="submit" class="btn-main2" style="font-size: 12px">Filter date</button>
        <a href="{% url 'main_app:my_tasks' %}" class="btn-main2" style="font-size: 12px">Clear all filters</a>
    </form>

</div>

<div class="sort-bar" style="display:flex; flex-wrap:wrap; gap:12px; margin-bottom:20px;">

    {% for col in sort_columns %}
    <form method="get" class="sort-form">
        {% for key,val in request.GET.items %}
            {% if key != "sort" and key != "order" %}
                <input type="hidden" name="{{ key }}" value="{{ val }}">
            {% endif %}
        {% endfor %}

        <select name="order" class="sort-select" onchange="this.form.submit()">
            <option value="">Sort by {{ col.label }}</option>

            <option value="asc"
                {% if request.GET.sort == col.field and request.GET.order == "asc" %}
                    selected
                {% endif %}
            >
                ↑ {{ col.label }} (ASC)
            </option>

            <option value="desc"
                {% if request.GET.sort == col.field and request.GET.order == "desc" %}
                    selected
                {% endif %}
            >
                ↓ {{ col.label }} (DESC)
            </option>
        </select>

        <input type="hidden" name="sort" value="{{ col.field }}">
    </form>
    {% endfor %}

</div>



<table>
    <thead>
        <tr>
            {% for col in sort_columns %}
                <th>{{ col.label }}</th>
            {% endfor %}
            <th>Delete</th>
        </tr>
    </thead>

    <tbody>
    {% for task in tasks %}
        <tr class="task-row" data-href="{% url 'main_app:one_task' task.id %}">

            <td>{{ task.task_name|truncatechars:100 }}</td>
            <td>{{ task.assignee.first_name|truncatechars:100 }}</td>
            <td>{{ task.task_description|truncatechars:100 }}</td>
            <td>{{ task.status }}</td>
            <td>{{ task.priority }}</td>

            <!-- FIXED PROJECT COLUMN — no duplicates -->
            <td>
                {% for p in task.projects.all %}
                    {{ p.project_name }}{% if not forloop.last %}, {% endif %}
                {% empty %}
                    —
                {% endfor %}
            </td>

            <td>{{ task.due_date }}</td>

            <td>
                <form method="post" action="{% url 'main_app:task_delete' task.id %}">
                    {% csrf_token %}
                    <button type="submit" class="button-delete">X</button>
                </form>
            </td>

        </tr>
    {% endfor %}
    </tbody>
</table>

{% if is_paginated %}
<div class="pagination">

    {% if page_obj.has_previous %}
        <a class="page-btn" href="?page={{ page_obj.previous_page_number }}{% for key,val in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ val }}{% endif %}{% endfor %}">
            ← Previous
        </a>
    {% endif %}

    <span class="page-number">
        Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}
    </span>

    {% if page_obj.has_next %}
        <a class="page-btn" href="?page={{ page_obj.next_page_number }}{% for key,val in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ val }}{% endif %}{% endfor %}">
            Next →
        </a>
    {% endif %}

</div>
{% endif %}


<script>
document.addEventListener("DOMContentLoaded", function () {
    document.querySelectorAll(".task-row").forEach(row => {
        row.addEventListener("click", () => {
            window.location = row.dataset.href;
        });
    });
});
</script>

{% endblock %}
