{% extends "base.html" %}

{% block title %}Project: {{ project.project_name }}{% endblock %}

{% block content %}

<div style="display: flex; gap: 30px; padding: 20px; width: 100%;">

    <!-- LEFT: Full table with tasks -->
    <div style="flex: 1; display: flex; flex-direction: column;">

        <!-- FILTERS -->
        <div class="filters-box">
            <form method="get" id="filtersForm" style="margin-bottom:20px">

                <!-- STATUS -->
                <select class="custom-select" name="status" onchange="filtersForm.submit()">
                    <option value="">All statuses</option>
                    <option value="Backlog"      {% if request.GET.status == "Backlog" %}selected{% endif %}>Backlog</option>
                    <option value="To do"        {% if request.GET.status == "To do" %}selected{% endif %}>To do</option>
                    <option value="In progress"  {% if request.GET.status == "In progress" %}selected{% endif %}>In progress</option>
                    <option value="Done"         {% if request.GET.status == "Done" %}selected{% endif %}>Done</option>
                </select>

                <!-- PRIORITY -->
                <select class="custom-select" name="priority" onchange="filtersForm.submit()">
                    <option value="">All priorities</option>
                    <option value="Low"     {% if request.GET.priority == "Low" %}selected{% endif %}>Low</option>
                    <option value="Medium"  {% if request.GET.priority == "Medium" %}selected{% endif %}>Medium</option>
                    <option value="High"    {% if request.GET.priority == "High" %}selected{% endif %}>High</option>
                    <option value="Urgent"  {% if request.GET.priority == "Urgent" %}selected{% endif %}>Urgent</option>
                </select>

                <!-- ASSIGNEE -->
                <select class="custom-select" name="assignee" onchange="filtersForm.submit()">
                    <option value="">All assignees</option>
                    {% for user in assignees %}
                        <option value="{{ user.id }}" {% if request.GET.assignee == user.id|stringformat:'s' %}selected{% endif %}>
                            {{ user.first_name }}
                        </option>
                    {% endfor %}
                </select>

                <a href="?">Clear filters</a>
            </form>

        </div>

        <!-- SORT BAR -->
        <div class="sort-bar" style="display:flex; flex-wrap:wrap; gap:12px; margin-bottom:20px;">

            {% for col in sort_columns %}
            <form method="get" class="sort-form">
                {% for key,val in request.GET.items %}
                    {% if key != "sort" and key != "order" %}
                        <input type="hidden" name="{{ key }}" value="{{ val }}">
                    {% endif %}
                {% endfor %}

                <select name="order" class="sort-select" onchange="this.form.submit()">
                    <option value="">Sort by {{ col.label }}</option>

                    <option value="asc"
                        {% if request.GET.sort == col.field and request.GET.order == "asc" %}
                            selected
                        {% endif %}
                    >
                        ↑ {{ col.label }} (ASC)
                    </option>

                    <option value="desc"
                        {% if request.GET.sort == col.field and request.GET.order == "desc" %}
                            selected
                        {% endif %}
                    >
                        ↓ {{ col.label }} (DESC)
                    </option>
                </select>

                <input type="hidden" name="sort" value="{{ col.field }}">
            </form>
            {% endfor %}

        </div>

        <!-- TASKS TABLE -->
        <table>
            <thead>
                <tr>
                    {% for col in sort_columns %}
                        <th>{{ col.label }}</th>
                    {% endfor %}
                    <th>Delete</th>
                </tr>
            </thead>
            <tbody>
                {% for task in tasks %}
                    <tr class="task-row" data-href="{% url 'main_app:one_task' task.id %}">
                        <td>{{ task.task_name|truncatechars:100 }}</td>
                        <td>{{ task.due_date|date:"d M Y" }}</td>
                        <td>{{ task.assignee.first_name|default:"Unassigned" }}</td>
                        <td>{{ task.status }}</td>
                        <td>{{ task.priority }}</td>
                        <td class="center-button">
                            <form method="post" action="{% url 'main_app:task_delete' task.id %}" onclick="event.stopPropagation();">
                                {% csrf_token %}
                                <button type="submit" class="button-delete">X</button>
                            </form>
                        </td>
                    </tr>
                {% empty %}
                    <tr>
                        <td colspan="6" style="text-align:center; color:#999; padding: 40px;">
                            No tasks in this project
                        </td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- RIGHT: Project Info Sidebar -->
    <div style="width: 280px; display: flex; flex-direction: column;">

        <!-- PROJECT TITLE CARD -->
        <div class="project-title" style="margin-bottom: 20px;">
            {{ project.project_name }}
        </div>

        <!-- PROJECT DESCRIPTION -->
        <div class="project-description-box" style="margin-bottom: 20px; flex: 1;">
            <h4 style="font-weight: 600; color: #374151; margin-bottom: 10px;">Description</h4>
            <p class="project-description" style="font-size: 14px; line-height: 1.5;">
                {% if project.project_description %}
                    {{ project.project_description|linebreaks }}
                {% else %}
                    <i style="color: #999;">No description provided.</i>
                {% endif %}
            </p>
        </div>

        <!-- PROJECT INFO -->
        <div style="display: flex; flex-direction: column; gap: 12px; margin-bottom: 20px;">

            <div class="project-info-box">
                <strong style="color: #374151;">Status</strong>
                <div style="margin-top: 6px; color: #4b5563; font-size: 14px;">
                    {{ project.status }}
                </div>
            </div>

            <div class="project-info-box">
                <strong style="color: #374151;">Priority</strong>
                <div style="margin-top: 6px; color: #4b5563; font-size: 14px;">
                    {{ project.priority }}
                </div>
            </div>

            <div class="project-info-box">
                <strong style="color: #374151;">Total tasks</strong>
                <div style="margin-top: 6px; color: #4b5563; font-size: 14px;">
                    {{ project.tasks.count }}
                </div>
            </div>

            <div class="project-info-box">
                <strong style="color: #374151;">Creator</strong>
                <div style="margin-top: 6px; color: #4b5563; font-size: 14px;">
                    {{ project.creator.first_name }}
                </div>
            </div>

            <div class="project-info-box">
                <strong style="color: #374151;">Collaborators</strong>
                <div style="margin-top: 6px; color: #4b5563; font-size: 14px;">
                    {% if project.collaborators.all %}
                        <ul style="margin: 0; padding-left: 18px;">
                            {% for u in project.collaborators.all %}
                                <li>{{ u.first_name }}</li>
                            {% endfor %}
                        </ul>
                    {% else %}
                        <i style="color: #999;">No collaborators</i>
                    {% endif %}
                </div>
            </div>

        </div>

        <!-- ACTION BUTTONS -->
        <div style="display: flex; flex-direction: column; gap: 10px;">

            <a href="{% url 'main_app:project_edit' project.id %}" style="width: 100%;">
                <button class="btn-main2" style="width:100%; font-size: 14px;">Edit project</button>
            </a>

            <a href="{% url 'main_app:project_report' project.id %}" style="width: 100%;">
                <button class="button-main" style="width:100%; font-size: 14px;">Generate report</button>
            </a>

            <form action="{% url 'main_app:project_delete' project.id %}" method="post" style="width: 100%;">
                {% csrf_token %}
                <button type="submit" class="button-delete" style="width:100%; font-size: 14px; padding: 10px;">Delete project</button>
            </form>

            <a href="{% url 'main_app:projects_view' %}" style="width: 100%;">
                <button class="button-main" style="width:100%; font-size: 14px;">Back to projects</button>
            </a>

        </div>

    </div>

</div>

<script>
document.addEventListener("DOMContentLoaded", function () {
    document.querySelectorAll(".task-row").forEach(row => {
        row.addEventListener("click", function(event) {
            if (event.target.tagName.toLowerCase() === 'button' || event.target.closest('form')) return;
            window.location = row.dataset.href;
        });
    });
});
</script>

{% endblock %}
