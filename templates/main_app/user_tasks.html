{% extends "base.html" %}
{% load static %}

{% block title %}{{ user.first_name }} – Tasks{% endblock %}

{% block content %}

<div>
<h2 style="margin-bottom: 20px">
    Tasks assigned to 
    <span style="color: #3b82f6; font-weight: 600;">
        {{ user.first_name }} {{ user.last_name }}
    </span>
</h2>

<div class="filters-box">
    <form method="get" id="filtersForm" style="margin-bottom:20px">

        <!-- STATUS -->
        <select class="custom-select" name="status" onchange="filtersForm.submit()">
            <option value="">All statuses</option>
            <option value="Backlog"      {% if request.GET.status == "Backlog" %}selected{% endif %}>Backlog</option>
            <option value="To do"        {% if request.GET.status == "To do" %}selected{% endif %}>To do</option>
            <option value="In progress"  {% if request.GET.status == "In progress" %}selected{% endif %}>In progress</option>
            <option value="Done"         {% if request.GET.status == "Done" %}selected{% endif %}>Done</option>
        </select>

        <!-- PRIORITY -->
        <select class="custom-select" name="priority" onchange="filtersForm.submit()">
            <option value="">All priorities</option>
            <option value="Low"     {% if request.GET.priority == "Low" %}selected{% endif %}>Low</option>
            <option value="Medium"  {% if request.GET.priority == "Medium" %}selected{% endif %}>Medium</option>
            <option value="High"    {% if request.GET.priority == "High" %}selected{% endif %}>High</option>
            <option value="Urgent"  {% if request.GET.priority == "Urgent" %}selected{% endif %}>Urgent</option>
        </select>

        <!-- ASSIGNEE -->
        <select class="custom-select" name="assignee" onchange="filtersForm.submit()">
            <option value="">All assignees</option>
            {% for user in assignees %}
                <option value="{{ user.id }}" {% if request.GET.assignee == user.id|stringformat:'s' %}selected{% endif %}>
                    {{ user.first_name }}
                </option>
            {% endfor %}
        </select>

        <a href="{% url 'main_app:users_tasks' user.id %}" class="btn-main2" style="font-size: 12px">Clear all filters</a>
    </form>

</div>

<div class="sort-bar" style="display:flex; flex-wrap:wrap; gap:12px; margin-bottom:20px;">

    {% for col in sort_columns %}
    <form method="get" class="sort-form">
        {% for key,val in request.GET.items %}
            {% if key != "sort" and key != "order" %}
                <input type="hidden" name="{{ key }}" value="{{ val }}">
            {% endif %}
        {% endfor %}

        <select name="order" class="sort-select" onchange="this.form.submit()">
            <option value="">Sort by {{ col.label }}</option>

            <option value="asc"
                {% if request.GET.sort == col.field and request.GET.order == "asc" %}
                    selected
                {% endif %}
            >
                ↑ {{ col.label }} (ASC)
            </option>

            <option value="desc"
                {% if request.GET.sort == col.field and request.GET.order == "desc" %}
                    selected
                {% endif %}
            >
                ↓ {{ col.label }} (DESC)
            </option>
        </select>

        <input type="hidden" name="sort" value="{{ col.field }}">
    </form>
    {% endfor %}

</div>

    <table>
        <thead>
        <tr>
            {% for col in sort_columns %}
                <th>{{ col.label }}</th>
            {% endfor %}
        </tr>
        </thead>

        <tbody>
        {% for task in tasks %}
            <tr class="task-row" data-href="{% url 'main_app:one_task' task.id %}">
                <td>{{ task.task_name }}</td>
                <td>{{ task.task_description|truncatechars:100 }}</td>
                <td>{{ task.status }}</td>
                <td>{{ task.priority }}</td>
                <td>{{ task.due_date|date:"d M Y" }}</td>
                <td>{{ task.created_at|date:"d M Y" }}</td>
            </tr>
        {% empty %}
            <tr>
                <td colspan="6" style="text-align:center; color:#666; padding: 25px;">
                    No tasks assigned.
                </td>
            </tr>
        {% endfor %}
        </tbody>
    </table>

    <a href="{% url 'main_app:users_list' %}">
        <button class="btn-main2">Back to users</button>
    </a>

</div>


<script>
document.addEventListener("DOMContentLoaded", function () {
    document.querySelectorAll(".task-row").forEach(row => {
        row.addEventListener("click", () => {
            window.location = row.dataset.href;
        });
    });
});
</script>

{% endblock %}
