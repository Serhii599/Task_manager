{% extends "base.html" %}
{% block title %}My tasks table{% endblock %}
{% block content %}

<div class="filters-box">
    <form method="get" id="filtersForm" style="margin-bottom:20px">

        <!-- STATUS -->
        <select class="custom-select" name="status" onchange="filtersForm.submit()">
            <option value="">All statuses</option>
            <option value="Backlog"      {% if request.GET.status == "Backlog" %}selected{% endif %}>Backlog</option>
            <option value="To do"        {% if request.GET.status == "To do" %}selected{% endif %}>To do</option>
            <option value="In progress"  {% if request.GET.status == "In progress" %}selected{% endif %}>In progress</option>
            <option value="Done"         {% if request.GET.status == "Done" %}selected{% endif %}>Done</option>
        </select>

        <!-- PRIORITY -->
        <select class="custom-select" name="priority" onchange="filtersForm.submit()">
            <option value="">All priorities</option>
            <option value="Low"     {% if request.GET.priority == "Low" %}selected{% endif %}>Low</option>
            <option value="Medium"  {% if request.GET.priority == "Medium" %}selected{% endif %}>Medium</option>
            <option value="High"    {% if request.GET.priority == "High" %}selected{% endif %}>High</option>
            <option value="Urgent"  {% if request.GET.priority == "Urgent" %}selected{% endif %}>Urgent</option>
        </select>

        <!-- CREATOR -->
        <select class="custom-select" name="creator" onchange="filtersForm.submit()">
            <option value="">All creators</option>
            {% for user in creators %}
                <option value="{{ user.id }}" {% if request.GET.creator == user.id|stringformat:'s' %}selected{% endif %}>
                    {{ user.first_name }}
                </option>
            {% endfor %}
        </select>

        <a href="{% url 'main_app:projects_view' %}" class="btn-main2" style="font-size: 12px">Clear all filters</a>
    </form>

</div>

<div class="sort-bar" style="display:flex; flex-wrap:wrap; gap:12px; margin-bottom:20px;">

    {% for col in sort_columns %}
    <form method="get" class="sort-form">
        {% for key,val in request.GET.items %}
            {% if key != "sort" and key != "order" %}
                <input type="hidden" name="{{ key }}" value="{{ val }}">
            {% endif %}
        {% endfor %}

        <select name="order" class="sort-select" onchange="this.form.submit()">
            <option value="">Sort by {{ col.label }}</option>

            <option value="asc"
                {% if request.GET.sort == col.field and request.GET.order == "asc" %}
                    selected
                {% endif %}
            >
                ↑ {{ col.label }} (ASC)
            </option>

            <option value="desc"
                {% if request.GET.sort == col.field and request.GET.order == "desc" %}
                    selected
                {% endif %}
            >
                ↓ {{ col.label }} (DESC)
            </option>
        </select>

        <input type="hidden" name="sort" value="{{ col.field }}">
    </form>
    {% endfor %}

</div>

<div>
    <table>
        <thead>
        <tr>
            {% for col in sort_columns %}
                <th>{{ col.label }}</th>
            {% endfor %}
            <th>Delete</th>
        </tr>
        </thead>
        <tbody>
        {% for project in projects %}
        <tr class="project-row" data-href="{% url 'main_app:one_project' project.id %}">
            <td>{{ project.project_name }}</td>
            <td>{{ project.status }}</td>
            <td>{{ project.priority }}</td>
            <td>{{ project.task_count }}</td>
            <td>{{ project.creator.first_name }}</td>
            <td>{{ project.created_at|date:"d M Y" }}</td>
            <td class="center-button">
                <form method="post" action="{% url 'main_app:project_delete' project.id %}">
                {% csrf_token %}
                <button type="submit" class="button-delete">X</button>
                </form>
            </td>
        </tr>
        {% endfor %}
        </tbody>
    </table>
</div>

<script>
document.addEventListener("DOMContentLoaded", function () {
    document.querySelectorAll(".project-row").forEach(row => {
        row.addEventListener("click", function(event) {
            if (event.target.tagName.toLowerCase() === 'button' || event.target.closest('form')) return;
            window.location = row.dataset.href;
        });
    });
});
</script>
{% endblock %}