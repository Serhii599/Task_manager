{% extends "base.html" %}

{% block title %}Report â€” {{ project.project_name }}{% endblock %}

{% block content %}

<div class="report-container">

    <!-- PAGE TITLE -->
    <div class="report-header">
        <div>
            <h2>Project Report</h2>
            <h3>{{ project.project_name }}</h3>
        </div>
        <a href="{% url 'main_app:project_report_excel' project.id %}" style="text-decoration: none;">
            <button class="button-download">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                    <polyline points="7 10 12 15 17 10"></polyline>
                    <line x1="12" y1="15" x2="12" y2="3"></line>
                </svg>
                Download Excel
            </button>
        </a>
    </div>

    <!-- SUMMARY CARDS -->
    <div class="report-cards">

        <div class="report-card">
            <span class="label">Total tasks</span>
            <span class="value">{{ project.tasks.count }}</span>
        </div>

        <div class="report-card">
            <span class="label">Tasks completed</span>
            <span class="value">{{ total_done }}</span>
        </div>

        <div class="report-card">
            <span class="label">Overdue tasks</span>
            <span class="value">{{ overdue_tasks.count }}</span>
        </div>
        
        <div class="report-card">
            <span class="label">Completion rate</span>
            <span class="value">
                {% widthratio total_done project.tasks.count 100 %}%
            </span>
        </div>

    </div>


    <!-- TOP 3 BY DEADLINE -->
    <div class="report-section">
        <h3>Top 3 Tasks â€” Nearest Deadlines</h3>

        {% if top_by_deadline %}
        <table class="report-table">
            <thead>
                <tr>
                    <th>Name</th>
                    <th>Assignee</th>
                    <th>Due date</th>
                    <th>Status</th>
                </tr>
            </thead>
            <tbody>
            {% for t in top_by_deadline %}
                <tr class="click-row" data-href="{% url 'main_app:one_task' t.id %}">
                    <td>{{ t.task_name }}</td>
                    <td>{{ t.assignee.first_name }}</td>
                    <td>{{ t.due_date|date:"d M Y" }}</td>
                    <td>{{ t.status }}</td>
                </tr>
            {% endfor %}
            </tbody>
        </table>
        {% else %}
        <p class="empty">No tasks available.</p>
        {% endif %}
    </div>


    <!-- TOP 3 BY PRIORITY -->
    <div class="report-section">
        <h3>Top 3 Tasks â€” Highest Priority</h3>

        {% if top_by_priority %}
        <table class="report-table">
            <thead>
                <tr>
                    <th>Name</th>
                    <th>Assignee</th>
                    <th>Priority</th>
                    <th>Due date</th>
                </tr>
            </thead>
            <tbody>
            {% for t in top_by_priority %}
                <tr class="click-row" data-href="{% url 'main_app:one_task' t.id %}">
                    <td>{{ t.task_name }}</td>
                    <td>{{ t.assignee.first_name }}</td>
                    <td>{{ t.priority }}</td>
                    <td>{{ t.due_date|date:"d M Y" }}</td>
                </tr>
            {% endfor %}
            </tbody>
        </table>
        {% else %}
        <p class="empty">No tasks available.</p>
        {% endif %}
    </div>


    <!-- OVERDUE TASKS -->
    <div class="report-section">
        <h3>Overdue Tasks</h3>

        {% if overdue_tasks %}
        <table class="report-table overdue-table">
            <thead>
                <tr>
                    <th>Name</th>
                    <th>Assignee</th>
                    <th>Due date</th>
                    <th>Status</th>
                </tr>
            </thead>
            <tbody>
            {% for t in overdue_tasks %}
                <tr class="click-row" data-href="{% url 'main_app:one_task' t.id %}">
                    <td>{{ t.task_name }}</td>
                    <td>{{ t.assignee.first_name }}</td>
                    <td class="danger">{{ t.due_date|date:"d M Y" }}</td>
                    <td>{{ t.status }}</td>
                </tr>
            {% endfor %}
            </tbody>
        </table>
        {% else %}
        <p class="empty">No overdue tasks ðŸŽ‰</p>
        {% endif %}
    </div>


    <!-- BACK -->
    <div class="report-back">
        <a href="{% url 'main_app:one_project' project.id %}">
            <button class="button-main">Back to project</button>
        </a>
    </div>

</div>


<script>
document.addEventListener("DOMContentLoaded", function () {
    document.querySelectorAll(".click-row").forEach(row => {
        row.addEventListener("click", () => {
            window.location = row.dataset.href;
        });
    });
});
</script>


{% endblock %}
