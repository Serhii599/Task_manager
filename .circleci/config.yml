version: 2.1

jobs:
  tests:
    docker:
      - image: cimg/python:3.12
      - image: cimg/postgres:15.3
        environment:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: test_taskmanager
    
    environment:
      DJANGO_SETTINGS_MODULE: config.settings.base
      DB_ENGINE: django.db.backends.postgresql
      DB_NAME: test_taskmanager
      DB_USER: postgres
      DB_PASSWORD: postgres
      DB_HOST: localhost
      DB_PORT: 5432
      SECRET_KEY: test-secret-key-for-ci
      DEBUG: "False"
      ALLOWED_HOSTS: "*"
    
    steps:
      - checkout
      
      - restore_cache:
          keys:
            - v1-dependencies-{{ checksum "requirements.txt" }}
            - v1-dependencies-
      
      - run:
          name: Install dependencies
          command: |
            python -m venv venv
            . venv/bin/activate
            pip install --upgrade pip
            pip install -r requirements.txt
            pip install -r requirements-dev.txt
      
      - save_cache:
          paths:
            - ./venv
          key: v1-dependencies-{{ checksum "requirements.txt" }}
      
      - run:
          name: Wait for PostgreSQL
          command: |
            for i in {1..30}; do
              pg_isready -h localhost -p 5432 && echo "PostgreSQL is ready" && exit 0
              echo "Waiting for PostgreSQL... ($i/30)"
              sleep 1
            done
            echo "PostgreSQL failed to start"
            exit 1
      
      - run:
          name: Run migrations
          command: |
            . venv/bin/activate
            python manage.py migrate --no-input
      
      - run:
          name: Run all tests with coverage
          command: |
            . venv/bin/activate
            coverage run --source='apps' manage.py test apps.main_app.test_models apps.main_app.test_views apps.main_app.test_forms apps.authentication.test_authentication --verbosity=2

  deploy:
    machine:
      image: ubuntu-2204:current
    steps:
      - add_ssh_keys
      - run:
          name: Deploy to server
          command: |
            ssh -o StrictHostKeyChecking=no $SERVER_USER@$SERVER_HOST "
              cd /home/ubuntu/Task_manager &&
              git pull origin main &&
              docker-compose -f docker-compose.prod.yml down &&
              docker-compose -f docker-compose.prod.yml build --no-cache &&
              docker-compose -f docker-compose.prod.yml up -d
            "

workflows:
  version: 2
  ci_cd:
    jobs:
      - tests
      - deploy:
          requires:
            - tests
          filters:
            branches:
              only: main
